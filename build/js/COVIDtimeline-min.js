const svgSupport=document.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#BasicStructure","1.1");var fullSweeps=[],dates=[];function getSortedKeys(e){return Object.keys(e).sort(function(e,t){return e-t})}function getJsDateFromExcel(e){let t=new Date(86400*(e-25569)*1e3);return t.setHours(0),t.setMinutes(0),t.setMilliseconds(0),t}function formatMonthYear(e){return monthNames[e.getMonth()]+" "+e.getFullYear()}function formatDayMonthYear(e){return e.getDate()+" "+monthNames[e.getMonth()]+" "+e.getFullYear()}$.getJSON("json/covid_timeline.json",function(e){fullSweeps=Object.values(e),$(document).ready(function(){sweeps=makeTimeline(fullSweeps),sweeps&&makeCircles(sweeps)})}),getKeyByValue=function(e,t){for(var a in e)if(e.hasOwnProperty(a)&&e[a]===t)return a};const monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"],timelineBackgroundTitles=[{title:"First confirmed UK death",date:"2020-03-05"},{title:"Non-essential buisinesses, schools close",date:"2020-03-20"},{title:"Lockdown begins",date:"2020-03-23"},{title:"UK deaths exceed 10,000",date:"2020-04-12"},{title:"UK deaths exceed 30,000",date:"2020-05-06"},{title:"Restrictions tighten accross UK",date:"2020-10-01"},{title:"Second lockdown begins",date:"2020-11-01"},{title:"Third lockdown begins",date:"2021-01-01"},{title:"Restrictions begin easing accross UK",date:"2021-04-01"}];function makeTimeline(e){var t=[],a={};if(null==e)return $("#timeline").parent().hide(),!1;for(var l=0;l<e.length;l++){let n=getJsDateFromExcel(e[l]["Start date"],e[l]["End date"]),i=e[l].Month;n=n.getTime(),-1==t.indexOf(i)&&(t.push(i),a[n]=i)}return a}function makeCircles(e){for(var t=[],a=[],l=0;l<timelineBackgroundTitles.length;l++)t.push(Date.parse(timelineBackgroundTitles[l].date)),a.push(timelineBackgroundTitles[l].title);dates=getSortedKeys(e);var n=Math.min(dates[0],t[0]),i=dates[dates.length-1]-n,s=!1;let r='<i class="fa fa-tree"></i>';svgSupport&&(r='<object type="image/svg+xml" class="svgTree" style="visibility:hidden;width:40px;height:55px;" data="img/svgTree.svg"></object>'),n==t[0]?(s=!0,$("#line").append('<div class="labelLine left above" id="label0" style="left:0%;"><div class="popupSpan label">'+a[0]+'</div><div class="popupSpan square"></div></div>')):$("#line").append('<div class="circle labelled left" id="circle0" style="left:0%;"><div class="popupSpan label">'+e[dates[0]]+'</div><div class="popupSpan tree">'+r+"</div></div>");var o=fullSweeps.filter(function(t){return t.Title==e[dates[0]]});for($("#dataTable").DataTable({data:o,responsive:{details:{type:"column",target:"tr"}},paging:!1,searchDelay:350,fixedHeader:{footer:!0},columns:[{title:"",data:null,defaultContent:"",class:"control",orderable:!1,searchable:!1},{title:"Study name",data:"Study name"},{title:"Start date",data:"Start date",render:function(e){return formatDayMonthYear(getJsDateFromExcel(e))}},{title:"End date",data:"End date",render:function(e){return formatDayMonthYear(getJsDateFromExcel(e))}},{title:"Mental health measures used",data:"Measures",class:"none"},{title:"Participants",data:"Participants",class:"none"},{title:"Data collection method",data:"Methodology",class:"none"},{title:"Data access",data:"Data access",class:"none"},{title:"Comments",data:"Comments",class:"none"},{title:"Links",data:"Links",class:"none"}],order:[1,"asc"]}),$("#dataTable").dataTable().fnAdjustColumnSizing(),$("#dataTable").dataTable().css("width","100%"),$("#dataTable").DataTable().on("responsive-display",function(e,t,a,l,n){l&&(a.nodes().to$().next().find("td.child").each(function(){$(this).attr("colspan",$(this).attr("colspan")-1),$(this).before("<td></td>")}),$("li[data-dt-row='"+a.index()+"'] .dtr-data").each(function(){""==$(this).text()&&$(this).parent().hide()}))}),$("#dataTable_filter").insertAfter($("#line")),$("#dataTable_filter  input").addClass("form-control").attr("placeholder","Search sweeps for ...").appendTo($("#dataTable_filter")),$("#dataTable_filter > label").remove(),l=s?0:1;l<dates.length-1;l++){var d=(dates[l]-n)/i;$("#line").append('<div class="circle" id="circle'+l+'" style="left: '+100*d+'%;"><div class="popupSpan label">'+e[dates[l]]+'</div><div class="popupSpan tree">'+r+"</div></div>")}for(l=s?1:0;l<t.length;l++){d=(t[l]-n)/i;let e="above";[1,3,4,8].includes(l)&&(e="below"),[3,2].includes(l)&&(e+=" hideable"),$("#line").append('<div class="labelLine '+e+'" id="labelLine'+l+'" style="left: '+100*d+'%;"><div class="popupSpan label">'+a[l]+"</div></div>")}$("#line").append('<div class="circle labelled right" id="circle'+(dates.length-1)+'" style="right:0;"><div class="popupSpan label">'+e[dates[dates.length-1]]+'</div><div class="popupSpan tree">'+r+"</div></div>");$("#dataTable").DataTable().on("search.dt",function(){var t=$("#dataTable").DataTable().search(),a=[];if(t.length>=3){var l=t.match(/(?:[^\s"]+|"[^"]*")+/g);for(var n in l)l[n].length<3&&l.splice(n,1);i="^(?=[\\s\\S]*("+(i=l.join("))(?=[\\s\\S]*(")+"))").replace(/["]/g,"");var i=new RegExp(i,"i");a=[];$.each(fullSweeps,function(t,l){var n="";for(var s in l)n+=l[s]+" ";i.test(n)&&-1==a.indexOf(dates.indexOf(getKeyByValue(e,l.Month)))&&a.push(dates.indexOf(getKeyByValue(e,l.Month)))})}for(n=0;n<fullSweeps.length;n++){let e=$("#circle"+n+" .tree");-1==a.indexOf(n)&&$(e).hasClass("treeShown")?($(e).removeClass("treeShown"),animateTreeAnimation("line",n,"shrink")):-1==a.indexOf(n)||$(e).hasClass("treeShown")||($(e).addClass("treeShown"),animateTreeAnimation("line",n,"grow"))}}),dates.length<2&&($("#timeline .sweepTitle").html("Showing measures used in sweep: <b>"+e[dates[0]]+"</b><br><i>No other sweeps</i>").addClass("mb-4"),$("#line").hide()),selectDate($(".circle:first").attr("id")),$(".circle").mouseenter(function(){$(this).addClass("hover")}),$(".circle").mouseleave(function(){$(this).removeClass("hover")}),$(".circle").click(function(){var t=$(this).attr("id"),a=t.replace("circle","");selectDate(t),gtag("event","click",{event_label:"Study: "+$("#studyid").val()+" Sweep: "+e[dates[a]],event_category:"Timeline",transport_type:"beacon"})}),svgSupport&&$(".svgTree").on("load",function(){stopAndResetTreeAnimation($(this.contentDocument.documentElement)),setupTreeAnimation($(this.contentDocument.documentElement)),$(this).css("visibility","visible"),$(this).parent().hasClass("treeShown")&&animateTreeAnimation($(this).closest(".line").attr("id"),$(this).closest(".circle").attr("data-id").replace("circle",""),"grow")})}function selectDate(e){$(".active").removeClass("active"),$("#"+e).addClass("active");var t=e.replace("circle",""),a=sweeps[dates[t]];$("#timeline .sweepTitle").html("Showing studies collecting data in: <b>"+sweeps[dates[t]]+"</b><br><i>click on the timeline to see other timepoints");var l=fullSweeps.filter(function(e){return e.Month==a});$("#dataTable").dataTable().fnClearTable(),$("#dataTable").dataTable().fnAddData(l),$("#dataTable").dataTable().fnAdjustColumnSizing(),$("#dataTable").dataTable().css("width","100%"),t>0&&collide($("#"+e+" .label")[0],$("#circle0 .label")[0])?$("#circle0 .label").css("visibility","hidden"):$("#circle0 .label").css("visibility","visible"),t<dates.length-1&&collide($("#"+e+" .label")[0],$("#circle"+(dates.length-1)+" .label")[0])?$("#circle"+(dates.length-1)+" .label").css("visibility","hidden"):$("#circle"+(dates.length-1)+" .label").css("visibility","visible"),$('[data-toggle="tooltip"]').tooltip({container:"body",boundary:"window",offset:0})}function collide(e,t){var a=e.getBoundingClientRect(),l=t.getBoundingClientRect();return!(a.top>l.bottom||a.right<l.left||a.bottom<l.top||a.left>l.right)}function setupTreeAnimation(e){TweenMax.set(e.find(".shadow"),{scale:0,transformOrigin:"15px 8px"}),TweenMax.set(e.find(".tree"),{scale:0,transformOrigin:"154px bottom"}),TweenMax.set(e.find(".leaf-rb"),{scale:0,rotation:"-60cw",y:-15,transformOrigin:"left bottom"}),TweenMax.set(e.find(".leaf-rm"),{scale:0,rotation:"-50cw",y:30,transformOrigin:"left bottom"}),TweenMax.set(e.find(".leaf-lb"),{scale:0,rotation:"60cw",y:-80,transformOrigin:"right bottom"}),TweenMax.set(e.find(".leaf-lm"),{scale:0,rotation:"40cw",y:-90,transformOrigin:"right bottom"}),TweenMax.set(e.find(".leaf-top"),{scale:0,transformOrigin:"center bottom"}),TweenMax.set(e.find(".leaf-rb g"),{scale:0,transformOrigin:"left 60px"}),TweenMax.set(e.find(".leaf-rm g"),{scale:0,transformOrigin:"22px 140px"}),TweenMax.set(e.find(".leaf-lb g"),{scale:0,transformOrigin:"right 56px"}),TweenMax.set(e.find(".leaf-lm g"),{scale:0,transformOrigin:"106px bottom"})}function animateTreeAnimation(e,t,a){if(svgSupport&&(elem=$("#"+e+' .circle[id="circle'+t+'"] .svgTree')[0],elem.contentDocument)){stopAndResetTreeAnimation($(elem.contentDocument.documentElement)),setupTreeAnimation($(elem.contentDocument.documentElement));let e=getAnimationTimeline($(elem.contentDocument.documentElement));$(".treeShown").css("font-size",0),"grow"==a&&e.timeScale(3).play(),"shrink"==a&&e.timeScale(3).reverse(0)}}function validatePropertyName(e){return e.replace(/[^A-Za-z_]/,"")}function getAnimationTimeline(e){var t=new TimelineMax({repeat:0});return t.to(e.find(".shadow"),2,{scale:1},0).to(e.find(".tree"),2,{scale:1},0).to(e.find(".leaf-rb"),2,{scale:1,rotation:"0cw",y:0,delay:.35},0).to(e.find(".leaf-rm"),2,{scale:1,rotation:"0cw",y:0,delay:.35},0).to(e.find(".leaf-lb"),2,{scale:1,rotation:"0cw",y:0,delay:.35},0).to(e.find(".leaf-lm"),2,{scale:1,rotation:"0cw",y:0,delay:.35},0).to(e.find(".leaf-top"),2.5,{scale:1,delay:.35},0).to(e.find(".leaf-lb g"),2.25,{scale:1,delay:.5},0).to(e.find(".leaf-lm g"),2.25,{scale:1,delay:.6},0).to(e.find(".leaf-rb g"),2.25,{scale:1,delay:.5},0).to(e.find(".leaf-rm g"),2.25,{scale:1,delay:.6},0),t}function stopAndResetTreeAnimation(e){TweenMax.set(e.find(".tree"),{clearProps:"all"}),TweenMax.set(e.find(".shadow"),{clearProps:"all"}),TweenMax.set(e.find(".leaf-top"),{clearProps:"all"}),TweenMax.set(e.find(".leaf-rb"),{clearProps:"all"}),TweenMax.set(e.find(".leaf-rm"),{clearProps:"all"}),TweenMax.set(e.find(".leaf-lb"),{clearProps:"all"}),TweenMax.set(e.find(".leaf-lm"),{clearProps:"all"}),TweenMax.set(e.find(".leaf-top"),{clearProps:"all"}),TweenMax.set(e.find(".leaf-rb g"),{clearProps:"all"}),TweenMax.set(e.find(".leaf-rm g"),{clearProps:"all"}),TweenMax.set(e.find(".leaf-lb g"),{clearProps:"all"}),TweenMax.set(e.find(".leaf-lm g"),{clearProps:"all"})}