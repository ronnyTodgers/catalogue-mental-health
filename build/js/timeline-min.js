var fullSweeps=[],sweeps=[],dates=[],tlGroups=[],standardInstruments={};const minSearchLength=3,svgSupport=document.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#BasicStructure","1.1");var treeAnimationTimeLines={};function isOverflown(e){return e.scrollHeight>e.clientHeight||e.scrollWidth>e.clientWidth}function applyReadMore(){$("#sweepComment, #sweepPhysHealth").each(function(){$(this).addClass("text-truncate"),$(this).off("click"),isOverflown($(this)[0])?($(this).addClass("readMore"),$(this).click(function(){$(this).toggleClass("text-truncate")})):$(this).removeClass("readMore")})}$.when($.get("?content=7",function(e){$(e).find("strong[id]").each(function(){let e=$(this).prop("id");standardInstruments[e]=$(this).parent()[0].outerHTML;let t=0;$(this).parent().nextAll().each(function(){if(t++,"HR"==$(this)[0].tagName||t>3||$(this).text().indexOf("Reference")>-1)return!1;standardInstruments[e]+=$(this)[0].outerHTML})})}),$.getJSON("api/getSweeps.php?studyid="+$("#studyid").val(),function(e){fullSweeps=e})).then(function(){for(var e=0;e<fullSweeps.length;e++){var t=fullSweeps[e];if("<i class='fas fa-check'></i>"==t["Standard Instrument"])for(var a in standardInstruments)if(t.Scale.indexOf(a)>-1){t.Scale="<div style='display:flex;align-items:center;'>"+t.Scale+"<i class='fas fa-info-circle infobutton' data-toggle='tooltip' data-html='true' title='"+standardInstruments[a]+"'></i></div>";break}}$(document).ready(function(){makeTimeLineGroups(fullSweeps),makeTimeline(fullSweeps)})});const monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"];function getJsDateFromExcel(e,t){let a=[e,t=t||e],i=[];for(let e=0;e<2;e++)a[e]<3e3?i[e]=Date.parse(a[e]+"-01-01"):(i[e]=new Date(86400*(a[e]-25569)*1e3),i[e].setDate(1),i[e].setHours(0),i[e].setMinutes(0),i[e].setMilliseconds(0),i[e]=i[e].getTime());return(i[0]+i[1])/2}function tlEntry(e,t,a,i,n,l,r){this.startDate=e,this.endDate=t,this.tlDate=(this.startDate+this.endDate)/2,this.title=a,this.label=i,this.cAge=n,this.comment=l,this.physHealth=r}function makeTimeLineGroups(e){tlGroups=[];let t=e.map(function(e){return e["Timeline Group"]}).filter(function(e,t,a){return a.indexOf(e)==t});for(var a=0;a<t.length;a++){let i=e.filter(function(e){return e["Timeline Group"]==t[a]}).map(function(e){return getJsDateFromExcel(e.Year)}).sort()[0],n=e.filter(function(e){return e["Timeline Group"]==t[a]}).map(function(e){return getJsDateFromExcel(e["End Year"])}).sort().pop();tlGroups.push(new tlEntry(i,n,t[a],t[a])),tlGroups=tlGroups.sort(function(e,t){return e.tlDate>t.tlDate?-1:t.tlDate>e.tlDate?1:void 0})}}function makeTimeline(e,t){let a=!1;var i=e.slice();if(null==e)return $("#timeline").parent().hide(),!1;null==t&&(a=!0),e[0].hasOwnProperty("Timeline Group")&&null!==e[0]["Timeline Group"]?(t=t||e[0]["Timeline Group"],a&&makeCircles(tlGroups,$("#groupLine")),i=e.filter(function(e){return e["Timeline Group"]==t})):$("#lineContGroup").remove(),sweeps=[];let n=i.map(function(e){return e.Label}).filter(function(e,t,a){return a.indexOf(e)==t});for(var l=0;l<n.length;l++){let e=i.filter(function(e){return e.Label==n[l]})[0];sweeps.push(new tlEntry(getJsDateFromExcel(e.Year),getJsDateFromExcel(e["End Year"]),e.Title,e.Label,e["CM age"],e["Sweep Comments"],e["Physical Health Measures"]))}sweeps&&(makeCircles(sweeps,$("#line")),selectDate($("#line").find('.circle[data-id="circle0"]')))}function makeCircles(e,t){e=e.sort(function(e,t){return e.tlDate==t.tlDate?e.title>t.title?-1:e.title<t.title?1:0:e.tlDate<t.tlDate?-1:1}),t.find(".circle").remove(),dates=e.map(function(e){return Number(e.tlDate)}).filter(function(e,t,a){return a.indexOf(e)==t}).sort(function(e,t){return e-t});var a=Number(dates[0]),n=Number(dates[dates.length-1]),l=n-a;let r=1/(t.width()/l)*20;for(i=1;i<e.length-1;i++)e[i].tlDate-e[i-1].tlDate<r&&e[i-1].tlDate+r<=n&&(e[i].tlDate=e[i-1].tlDate+r);for(i=e.length-2;i>0;i--){let t=i==e.length-2?2*r:r;e[i+1].tlDate-e[i].tlDate<t&&e[i].tlDate-t>=a&&(e[i].tlDate=e[i+1].tlDate-t)}for(i=0;i<e.length;i++){var s=(e[i].tlDate-a)/l;let n='<i class="fa fa-tree"></i>';if(svgSupport&&(n='<object type="image/svg+xml" class="svgTree" style="visibility:hidden;width:40px;height:52px;" data="img/svgTree.svg"></object>'),0==i?t.append('<div class="circle labelled left" title="'+formatLabels(e[i].label,"tooltip")+'" data-id="circle'+i+'" style="left: 0;"><div class="popupSpan label">'+formatLabels(e[i].label,"tl")+'</div><div class="popupSpan tree">'+n+"</div></div>"):i==e.length-1?t.append('<div class="circle labelled right" title="'+formatLabels(e[i].label,"tooltip")+'" data-id="circle'+i+'" style="right: 0;"><div class="popupSpan label">'+formatLabels(e[i].label,"tl")+'</div><div class="popupSpan tree">'+n+"</div></div>"):t.append('<div class="circle" title="'+formatLabels(e[i].label,"tooltip")+'" data-id="circle'+i+'" style="left: '+100*s+'%;"><div class="popupSpan label">'+formatLabels(e[i].label,"tl")+'</div><div class="popupSpan tree">'+n+"</div></div>"),svgSupport){var o=$("#"+t.attr("id")+' .circle[data-id="circle'+i+'"] .svgTree');$(o)[0].addEventListener("load",function(){stopAndResetTreeAnimation($(this.contentDocument.documentElement)),setupTreeAnimation($(this.contentDocument.documentElement)),$(this).css("visibility","visible"),$(this).parent().hasClass("treeShown")&&animateTreeAnimation($(this).closest(".line").attr("id"),$(this).closest(".circle").attr("data-id").replace("circle",""),"grow")})}}e.length<2&&(displaySweepInfo(e[0],"<br><i>No other sweeps</i>"),$("#line").hide()),$(".circle").off("mouseenter").mouseenter(function(){$(this).addClass("hover")}),$(".circle").off("mouseleave").mouseleave(function(){$(this).removeClass("hover")}),$(".circle").off("click").click(function(){$(this).attr("data-id").replace("circle","");selectDate($(this),!0)})}function formatLabels(e,t){let a=e;switch(t){case"tl":a=e.replace(" || ","</br>");break;case"header":case"tooltip":a=e.replace(" || "," - ")}return a}function setDataTable(e){$.fn.DataTable.isDataTable("#dataTable")?($("#dataTable").dataTable().fnClearTable(!1),$("#dataTable").dataTable().fnAddData(e,!1)):($("#dataTable").DataTable({data:e,responsive:{details:{type:"column",target:"tr"}},paging:!1,searchDelay:350,fixedHeader:{footer:!0},columns:[{title:"",data:null,defaultContent:"",class:"control",orderable:!1,searchable:!1},{title:"Topic",data:"Topic"},{title:"Scale",data:"Scale"},{title:'<div title="The focus of a measure is the person who the measure is about">Focus</div>',data:"Focus"},{title:'<div title="The informant is the person who provides the information">Informant</div>',data:"Informant"},{title:'<div title="Standard instruments are measures which have published indication of validity and/or reliability. Standard instruments have often used in multiple studies.">Standard Instrument</div>',data:"Standard Instrument"},{title:"Reporting term",data:"Reporting term",class:"none"},{title:"Subscales",data:"Subscales",class:"none"},{title:"Questions",data:"Questions",class:"none"},{title:"Response scale",data:"Response scale",class:"none"},{title:"Comments",data:"Comments",class:"none"}],order:[1,"asc"]}),$("#dataTable").dataTable().fnAdjustColumnSizing(),$("#dataTable").dataTable().css("width","100%"),$("#dataTable").DataTable().on("responsive-display",function(e,t,a,i,n){i&&(a.nodes().to$().next().find("td.child").each(function(){$(this).attr("colspan",$(this).attr("colspan")-1),$(this).before("<td></td>")}),$("li[data-dt-row='"+a.index()+"'] .dtr-data").each(function(){""==$(this).text()&&$(this).parent().hide()}))}),$("#dataTable_filter").insertAfter($("#timeline > h6")),$("#dataTable_filter  input").addClass("form-control").attr("placeholder","Search sweeps for ...").appendTo($("#dataTable_filter")),$("#dataTable_filter > label").remove(),$("#dataTable").DataTable().on("search.dt",showTrees)),$('[data-toggle="tooltip"]').tooltip({container:"body",boundary:"window",offset:0}),$("#dataTable").dataTable().css("width","100%"),$("#dataTable").dataTable().fnAdjustColumnSizing()}function showTrees(){var e=$("#dataTable").DataTable().search(),t=[],a=[];if(e.length>=minSearchLength){var i=e.match(/(?:[^\s"]+|"[^"]*")+/g);for(var n in i)i[n].length<minSearchLength&&i.splice(n,1);l="^(?=[\\s\\S]*("+(l=i.join("))(?=[\\s\\S]*(")+"))").replace(/["]/g,"");var l=new RegExp(l,"i");$.each(fullSweeps,function(e,i){var n="";for(var r in i)n+=i[r]+" ";l.test(n)&&(t.push(tlGroups.map(function(e){return e.title}).indexOf(i["Timeline Group"])),a.push(sweeps.map(function(e){return e.title}).indexOf(i.Title)))}),a=a.filter(function(e,t,a){return e>-1&&a.indexOf(e)==t}),t=t.filter(function(e,t,a){return a.indexOf(e)==t})}for(n=0;n<tlGroups.length;n++){let e=$('#groupLine .circle[data-id="circle'+n+'"] .tree');e.length&&(-1==t.indexOf(n)&&$(e).hasClass("treeShown")?($(e).removeClass("treeShown"),animateTreeAnimation("groupLine",n,"shrink")):-1==t.indexOf(n)||$(e).hasClass("treeShown")||($(e).addClass("treeShown"),animateTreeAnimation("groupLine",n,"grow")))}for(n=0;n<sweeps.length;n++){let e=$('#line .circle[data-id="circle'+n+'"] .tree');-1==a.indexOf(n)&&$(e).hasClass("treeShown")?($(e).removeClass("treeShown"),animateTreeAnimation("line",n,"shrink")):-1==a.indexOf(n)||$(e).hasClass("treeShown")||($(e).addClass("treeShown"),animateTreeAnimation("line",n,"grow"))}0==$("#line .circle.active .treeShown").length&&($("#line .circle .treeShown").length?selectDate($("#line .circle:has(.treeShown)").first()):$("#groupLine .circle .treeShown").length&&(selectDate($("#groupLine .circle:has(.treeShown)").first()),selectDate($("#line .circle:has(.treeShown)").first()))),$('[data-toggle="tooltip"]').tooltip({container:"body",boundary:"window",offset:0})}function displaySweepInfo(e,t){$("#sweepTitle > span").html(formatLabels(e.title,"header")),$("#sweepCMage > span").html(e.cAge),e.physHealth?$("#sweepPhysHealth > span").html(e.physHealth):$("#sweepPhysHealth > span").html("No detailed physical health assessment matching Catalogue criteria");let a=[new Date(e.startDate),new Date(e.endDate)];var i;i=a[0].getFullYear()==a[1].getFullYear()?a[0].getMonth()==a[1].getMonth()?monthNames[a[0].getMonth()]+" "+a[0].getFullYear():monthNames[a[0].getMonth()]+" - "+monthNames[a[1].getMonth()]+" "+a[1].getFullYear():monthNames[a[0].getMonth()]+" "+a[0].getFullYear()+" - "+monthNames[a[1].getMonth()]+" "+a[1].getFullYear(),$("#sweepDates > span").html(i),e.comment?($("#sweepComment").show(),$("#sweepComment > span").html(e.comment)):($("#sweepComment").hide(),$("#sweepComment > span").html("")),applyReadMore()}function selectDate(e,t){$line=e.parent(".line"),$line.find(".active").removeClass("active"),e.addClass("active");var a=e.attr("data-id").replace("circle",""),i="",n=!1;(deCollide(a,e,$line),"groupLine"==$line.attr("id"))?(makeTimeline(fullSweeps,tlGroups[a].title),drawRangeLines(),n=!0,i=tlGroups[a].title):(i=sweeps[a].title,displaySweepInfo(sweeps[a]),setDataTable(fullSweeps.filter(function(e){return e.Title==i})),$('[data-toggle="tooltip"]').tooltip({container:"body",boundary:"window",offset:0}));t&&(n?gtag("event","click",{event_label:"Study: "+$("#studyid").val()+" Group: "+i,event_category:"Timeline Group",transport_type:"beacon"}):gtag("event","click",{event_label:"Study: "+$("#studyid").val()+" Sweep: "+i,event_category:"Timeline",transport_type:"beacon"}))}function drawRangeLines(){let e=$("#groupLine .circle.active")[0].getBoundingClientRect(),t=$("#groupLine")[0].getBoundingClientRect();$("#timeline-ranges-line-1").attr("x1",e.left-t.left+3),$("#timeline-ranges-line-2").attr("x1",e.right-t.left-3)}function deCollide(e,t,a){let i=a.find('.circle[data-id="circle0"]'),n=a.find(".circle").length;e>0&&!contained(t.find(".label")[0],a.parent(".lineCont")[0])&&(t.addClass("offsetLabel"),e>0&&!contained(t.find(".label")[0],a.parent(".lineCont")[0])&&t.addClass("offsetLabelRight")),e>0&&collide(t.find(".label")[0],i.find(".label")[0])?i.find(".label").css("visibility","hidden"):i.find(".label").css("visibility","visible"),e<n-1&&collide(t.find(".label")[0],a.find(".circle.right").find(".label")[0])?a.find(".circle.right").find(".label").css("visibility","hidden"):a.find(".circle.right").find(".label").css("visibility","visible")}function collide(e,t){var a=e.getBoundingClientRect(),i=t.getBoundingClientRect();return!(a.top>i.bottom||a.right<i.left||a.bottom<i.top||a.left>i.right)}function contained(e,t){var a=e.getBoundingClientRect(),i=t.getBoundingClientRect();return!(a.bottom>i.bottom||a.right>i.right||a.top<i.top||a.left<i.left)}function setupTreeAnimation(e){TweenMax.set(e.find(".shadow"),{scale:0,transformOrigin:"15px 8px"}),TweenMax.set(e.find(".tree"),{scale:0,transformOrigin:"154px bottom"}),TweenMax.set(e.find(".leaf-rb"),{scale:0,rotation:"-60cw",y:-15,transformOrigin:"left bottom"}),TweenMax.set(e.find(".leaf-rm"),{scale:0,rotation:"-50cw",y:30,transformOrigin:"left bottom"}),TweenMax.set(e.find(".leaf-lb"),{scale:0,rotation:"60cw",y:-80,transformOrigin:"right bottom"}),TweenMax.set(e.find(".leaf-lm"),{scale:0,rotation:"40cw",y:-90,transformOrigin:"right bottom"}),TweenMax.set(e.find(".leaf-top"),{scale:0,transformOrigin:"center bottom"}),TweenMax.set(e.find(".leaf-rb g"),{scale:0,transformOrigin:"left 60px"}),TweenMax.set(e.find(".leaf-rm g"),{scale:0,transformOrigin:"22px 140px"}),TweenMax.set(e.find(".leaf-lb g"),{scale:0,transformOrigin:"right 56px"}),TweenMax.set(e.find(".leaf-lm g"),{scale:0,transformOrigin:"106px bottom"})}function animateTreeAnimation(e,t,a){if(svgSupport&&(elem=$("#"+e+' .circle[data-id="circle'+t+'"] .svgTree')[0],elem.contentDocument)){stopAndResetTreeAnimation($(elem.contentDocument.documentElement)),setupTreeAnimation($(elem.contentDocument.documentElement));let e=getAnimationTimeline($(elem.contentDocument.documentElement));$(".treeShown").css("font-size",0),"grow"==a&&e.timeScale(3).play(),"shrink"==a&&e.timeScale(3).reverse(0)}}function validatePropertyName(e){return e.replace(/[^A-Za-z_]/,"")}function getAnimationTimeline(e){var t=new TimelineMax({repeat:0});return t.to(e.find(".shadow"),2,{scale:1},0).to(e.find(".tree"),2,{scale:1},0).to(e.find(".leaf-rb"),2,{scale:1,rotation:"0cw",y:0,delay:.35},0).to(e.find(".leaf-rm"),2,{scale:1,rotation:"0cw",y:0,delay:.35},0).to(e.find(".leaf-lb"),2,{scale:1,rotation:"0cw",y:0,delay:.35},0).to(e.find(".leaf-lm"),2,{scale:1,rotation:"0cw",y:0,delay:.35},0).to(e.find(".leaf-top"),2.5,{scale:1,delay:.35},0).to(e.find(".leaf-lb g"),2.25,{scale:1,delay:.5},0).to(e.find(".leaf-lm g"),2.25,{scale:1,delay:.6},0).to(e.find(".leaf-rb g"),2.25,{scale:1,delay:.5},0).to(e.find(".leaf-rm g"),2.25,{scale:1,delay:.6},0),t}function stopAndResetTreeAnimation(e){TweenMax.set(e.find(".tree"),{clearProps:"all"}),TweenMax.set(e.find(".shadow"),{clearProps:"all"}),TweenMax.set(e.find(".leaf-top"),{clearProps:"all"}),TweenMax.set(e.find(".leaf-rb"),{clearProps:"all"}),TweenMax.set(e.find(".leaf-rm"),{clearProps:"all"}),TweenMax.set(e.find(".leaf-lb"),{clearProps:"all"}),TweenMax.set(e.find(".leaf-lm"),{clearProps:"all"}),TweenMax.set(e.find(".leaf-top"),{clearProps:"all"}),TweenMax.set(e.find(".leaf-rb g"),{clearProps:"all"}),TweenMax.set(e.find(".leaf-rm g"),{clearProps:"all"}),TweenMax.set(e.find(".leaf-lb g"),{clearProps:"all"}),TweenMax.set(e.find(".leaf-lm g"),{clearProps:"all"})}