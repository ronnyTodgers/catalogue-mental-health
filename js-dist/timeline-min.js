var fullSweeps=[],sweeps=[],dates=[],tlGroups=[],standardInstruments={};const minSearchLength=3;function getJsDateFromExcel(e,t){let i=[e,t=t||e],a=[];for(let e=0;e<2;e++)i[e]<3e3?a[e]=Date.parse(i[e]+"-01-01"):(a[e]=new Date(86400*(i[e]-25569)*1e3),a[e].setDate(1),a[e].setHours(0),a[e].setMinutes(0),a[e].setMilliseconds(0),a[e]=a[e].getTime());return(a[0]+a[1])/2}function tlEntry(e,t,i){this.startDate=e,this.endDate=t,this.tlDate=(this.startDate+this.endDate)/2,this.title=i}function makeTimeLineGroups(e){tlGroups=[];let t=e.map(function(e){return e["Timeline Group"]}).filter(function(e,t,i){return i.indexOf(e)==t});for(var i=0;i<t.length;i++){let a=e.filter(function(e){return e["Timeline Group"]==t[i]}).map(function(e){return getJsDateFromExcel(e.Year)}).sort()[0],l=e.filter(function(e){return e["Timeline Group"]==t[i]}).map(function(e){return getJsDateFromExcel(e["End Year"])}).sort().pop();tlGroups.push(new tlEntry(a,l,t[i])),tlGroups=tlGroups.sort(function(e,t){return e.tlDate>t.tlDate?-1:t.tlDate>e.tlDate?1:void 0})}}function makeTimeline(e,t){let i=!1;var a=e.slice();if(null==e)return $("#timeline").parent().hide(),!1;null==t&&(i=!0),e[0].hasOwnProperty("Timeline Group")&&null!==e[0]["Timeline Group"]?(t=t||e[0]["Timeline Group"],i&&makeCircles(tlGroups,$("#groupLine")),a=e.filter(function(e){return e["Timeline Group"]==t})):$("#lineContGroup").remove(),sweeps=[];let l=a.map(function(e){return e.Title}).filter(function(e,t,i){return i.indexOf(e)==t});for(var n=0;n<l.length;n++){let e=a.filter(function(e){return e.Title==l[n]})[0];sweeps.push(new tlEntry(getJsDateFromExcel(e.Year),getJsDateFromExcel(e["End Year"]),e.Title))}sweeps&&(makeCircles(sweeps,$("#line")),selectDate($("#line").find('.circle[data-id="circle0"]')))}function makeCircles(e,t){e=e.sort(function(e,t){return e.tlDate==t.tlDate?e.title>t.title?-1:e.title<t.title?1:0:e.tlDate<t.tlDate?-1:1}),t.find(".circle").remove(),dates=e.map(function(e){return Number(e.tlDate)}).filter(function(e,t,i){return i.indexOf(e)==t}).sort(function(e,t){return e-t});var a=Number(dates[0]),l=Number(dates[dates.length-1]),n=l-a;let r=1/(t.width()/n)*20;for(i=1;i<e.length-1;i++)e[i].tlDate-e[i-1].tlDate<r&&e[i-1].tlDate+r<=l&&(e[i].tlDate=e[i-1].tlDate+r);for(i=e.length-2;i>0;i--)e[i+1].tlDate-e[i].tlDate<r&&e[i].tlDate-r>=a&&(e[i].tlDate=e[i+1].tlDate-r,i==e.length-2&&(e[i].tlDate=e[i].tlDate-r));for(i=0;i<e.length;i++){var s=(e[i].tlDate-a)/n;0==i?t.append('<div class="circle labelled left" data-id="circle'+i+'" style="left: 0;"><div class="popupSpan label">'+e[i].title+'</div><div class="popupSpan tree"><i class="fa fa-tree"></i></div></div>'):i==e.length-1?t.append('<div class="circle labelled right" data-id="circle'+i+'" style="right: 0;"><div class="popupSpan label">'+e[i].title+'</div><div class="popupSpan tree"><i class="fa fa-tree"></i></div></div>'):t.append('<div class="circle" data-id="circle'+i+'" style="left: '+100*s+'%;"><div class="popupSpan label">'+e[i].title+'</div><div class="popupSpan tree"><i class="fa fa-tree"></i></div></div>')}e.length<2&&($("#timeline .sweepTitle").html("Showing measures used in sweep: <b>"+e[0].title+"</b><br><i>No other sweeps</i>").addClass("mb-4"),$("#line").hide()),$(".circle").off("mouseenter").mouseenter(function(){$(this).addClass("hover")}),$(".circle").off("mouseleave").mouseleave(function(){$(this).removeClass("hover")}),$(".circle").off("click").click(function(){$(this).attr("data-id").replace("circle","");selectDate($(this),!0)})}function setDataTable(e){$.fn.DataTable.isDataTable("#dataTable")?($("#dataTable").dataTable().fnClearTable(!1),$("#dataTable").dataTable().fnAddData(e,!1)):($("#dataTable").DataTable({data:e,responsive:{details:{type:"column",target:"tr"}},paging:!1,searchDelay:350,fixedHeader:{footer:!0},columns:[{title:"",data:null,defaultContent:"",class:"control",orderable:!1,searchable:!1},{title:"Topic",data:"Topic"},{title:"Scale",data:"Scale"},{title:'<div title="The focus of a measure is the person who the measure is about">Focus</div>',data:"Focus"},{title:'<div title="The informant is the person who provides the information">Informant</div>',data:"Informant"},{title:'<div title="Standard instruments are measures which have published indication of validity and/or reliability. Standard instruments have often used in multiple studies.">Standard Instrument</div>',data:"Standard Instrument"},{title:"Reporting term",data:"Reporting term",class:"none"},{title:"Subscales",data:"Subscales",class:"none"},{title:"Questions",data:"Questions",class:"none"},{title:"Response scale",data:"Response scale",class:"none"},{title:"Comments",data:"Comments",class:"none"}],order:[1,"asc"]}),$("#dataTable").dataTable().fnAdjustColumnSizing(),$("#dataTable").dataTable().css("width","100%"),$("#dataTable").DataTable().on("responsive-display",function(e,t,i,a,l){a&&(i.nodes().to$().next().find("td.child").each(function(){$(this).attr("colspan",$(this).attr("colspan")-1),$(this).before("<td></td>")}),$("li[data-dt-row='"+i.index()+"'] .dtr-data").each(function(){""==$(this).text()&&$(this).parent().hide()}))}),$("#dataTable_filter").insertAfter($("#lineCont")),$("#dataTable_filter  input").addClass("form-control").attr("placeholder","Search sweeps for ...").appendTo($("#dataTable_filter")),$("#dataTable_filter > label").remove(),$("#dataTable").DataTable().on("search.dt",showTrees)),$('[data-toggle="tooltip"]').tooltip({container:"body",boundary:"window",offset:0}),$("#dataTable").dataTable().css("width","100%"),$("#dataTable").dataTable().fnAdjustColumnSizing()}function showTrees(){$(".tree").removeClass("treeShown");var e=$("#dataTable").DataTable().search();if(!(e.length<minSearchLength)){var t=e.match(/(?:[^\s"]+|"[^"]*")+/g);for(var i in t)t[i].length<minSearchLength&&t.splice(i,1);a="^(?=[\\s\\S]*("+(a=t.join("))(?=[\\s\\S]*(")+"))").replace(/["]/g,"");var a=new RegExp(a,"i"),l=[],n=[];for($.each(fullSweeps,function(e,t){var i="";for(var r in t)i+=t[r]+" ";a.test(i)&&(l.push(tlGroups.map(function(e){return e.title}).indexOf(t["Timeline Group"])),n.push(sweeps.map(function(e){return e.title}).indexOf(t.Title)))}),n=n.filter(function(e,t,i){return e>-1&&i.indexOf(e)==t}),l=l.filter(function(e,t,i){return i.indexOf(e)==t}),i=0;i<l.length;i++)$('#groupLine .circle[data-id="circle'+l[i]+'"] .tree').addClass("treeShown");for(i=0;i<n.length;i++)$('#line .circle[data-id="circle'+n[i]+'"] .tree').addClass("treeShown");0==$("#line .circle.active .treeShown").length&&($("#line .circle .treeShown").length?selectDate($("#line .circle:has(.treeShown)").first()):$("#groupLine .circle .treeShown").length&&(selectDate($("#groupLine .circle:has(.treeShown)").first()),selectDate($("#line .circle:has(.treeShown)").first())))}}function selectDate(e,t){$line=e.parent(".line"),$line.find(".active").removeClass("active"),e.addClass("active");var i=e.attr("data-id").replace("circle",""),a="",l=!1;(deCollide(i,e,$line),"groupLine"==$line.attr("id"))?(makeTimeline(fullSweeps,tlGroups[i].title),drawRangeLines(),l=!0,a=tlGroups[i].title):(a=sweeps[i].title,$(".sweepTitle").html("Showing measures used in sweep: <b>"+a+"</b><br><i>click on the timeline above to see other sweeps"),setDataTable(fullSweeps.filter(function(e){return e.Title==a})));t&&(l?gtag("event","click",{event_label:"Study: "+$("#studyid").val()+" Group: "+a,event_category:"Timeline Group",transport_type:"beacon"}):gtag("event","click",{event_label:"Study: "+$("#studyid").val()+" Sweep: "+a,event_category:"Timeline",transport_type:"beacon"}))}function drawRangeLines(){let e=$("#groupLine").width(),t=100*Number($("#groupLine .circle.active").css("left").replace("px",""))/e,i=100*(e-Number($("#groupLine .circle.active").css("right").replace("px","")))/e;$("#timeline-ranges-line-1").attr("x1",t+"%"),$("#timeline-ranges-line-2").attr("x1",i+"%")}function deCollide(e,t,i){let a=i.find('.circle[data-id="circle0"]'),l=i.find(".circle").length;contained(t.find(".label")[0],i.parent(".lineCont")[0])||(t.addClass("offsetLabel"),contained(t.find(".label")[0],i.parent(".lineCont")[0])||t.addClass("offsetLabelRight")),e>0&&collide(t.find(".label")[0],a.find(".label")[0])?a.find(".label").css("visibility","hidden"):a.find(".label").css("visibility","visible"),e<l-1&&collide(t.find(".label")[0],i.find(".circle.right").find(".label")[0])?i.find(".circle.right").find(".label").css("visibility","hidden"):i.find(".circle.right").find(".label").css("visibility","visible")}function collide(e,t){var i=e.getBoundingClientRect(),a=t.getBoundingClientRect();return!(i.top>a.bottom||i.right<a.left||i.bottom<a.top||i.left>a.right)}function contained(e,t){var i=e.getBoundingClientRect(),a=t.getBoundingClientRect();return!(i.bottom>a.bottom||i.right>a.right||i.top<a.top||i.left<a.left)}$.when($.get("?content=7",function(e){$(e).find("strong[id]").each(function(){let e=$(this).prop("id");standardInstruments[e]=$(this).parent()[0].outerHTML;let t=0;$(this).parent().nextAll().each(function(){if(t++,"HR"==$(this)[0].tagName||t>3||$(this).text().indexOf("Reference")>-1)return!1;standardInstruments[e]+=$(this)[0].outerHTML})})}),$.getJSON("api/getSweeps.php?studyid="+$("#studyid").val(),function(e){fullSweeps=e})).then(function(){for(var e=0;e<fullSweeps.length;e++){var t=fullSweeps[e];if("<i class='fas fa-check'></i>"==t["Standard Instrument"])for(var i in standardInstruments)if(t.Scale.indexOf(i)>-1){t.Scale="<div style='display:flex;align-items:center;'>"+t.Scale+"<i class='fas fa-info-circle infobutton' data-toggle='tooltip' data-html='true' title='"+standardInstruments[i]+"'></i></div>";break}}$(document).ready(function(){makeTimeLineGroups(fullSweeps),makeTimeline(fullSweeps)})});