var fullSweeps=[],sweeps={},dates=[];function getSortedKeys(e){return Object.keys(e).sort(function(e,t){return e-t})}function getJsDateFromExcel(e){let t=new Date(86400*(e-25569)*1e3);return t.setDate(1),t.setHours(0),t.setMinutes(0),t.setMilliseconds(0),t}function formatMonthYear(e){return monthNames[e.getMonth()]+" "+e.getFullYear()}function formatDayMonthYear(e){return e.getDay()+1+" "+monthNames[e.getMonth()]+" "+e.getFullYear()}$.getJSON("json/covid_timeline.json",function(e){fullSweeps=Object.values(e),$(document).ready(function(){(sweeps=makeTimeline(fullSweeps))&&makeCircles(sweeps)})});const monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"],timelineBackgroundTitles=[{title:"First confirmed UK death",date:"2020-03-05"},{title:"Non-essential buisinesses, schools close",date:"2020-03-20"},{title:"Lockdown begins",date:"2020-03-23"},{title:"UK deaths exceed 10,000",date:"2020-04-12"},{title:"UK deaths exceed 30,000",date:"2020-05-06"},{title:"Some non-essential businesses re-open",date:"2020-07-04"}];function makeTimeline(e){var t=[],a={};if(null==e)return $("#timeline").parent().hide(),!1;for(var l=0;l<e.length;l++){let i=getJsDateFromExcel(e[l]["Start date"]),s=formatMonthYear(i);(i=i.getTime())>Date.parse("2020-09-15")&&i<Date.parse("2021-02-01")&&(s="Autumn/Winter 2020",i=Date.parse("2020-11-15")),i>Date.parse("2021-03-01")&&i<Date.parse("2021-06-02")&&(s="Spring 2021",i=Date.parse("2021-04-15")),-1==t.indexOf(s)&&(t.push(s),a[i]=s)}return a}function makeCircles(e){for(var t=[],a=[],l=0;l<timelineBackgroundTitles.length;l++)t.push(Date.parse(timelineBackgroundTitles[l].date)),a.push(timelineBackgroundTitles[l].title);dates=getSortedKeys(e);var i=Math.min(dates[0],t[0]),s=dates[dates.length-1]-i,n=!1;i==t[0]?(n=!0,$("#line").append('<div class="labelLine left above" id="label0" style="left:0%;"><div class="popupSpan label">'+a[0]+'</div><div class="popupSpan square"></div></div>')):$("#line").append('<div class="circle labelled left" id="circle0" style="left:0%;"><div class="popupSpan label">'+e[dates[0]]+'</div><div class="popupSpan tree"><i class="fa fa-tree"></i></div></div>');var r=fullSweeps.filter(function(t){return t.Title==e[dates[0]]});for($("#dataTable").DataTable({data:r,responsive:{details:{type:"column",target:"tr"}},paging:!1,searchDelay:350,fixedHeader:{footer:!0},columns:[{title:"",data:null,defaultContent:"",class:"control",orderable:!1,searchable:!1},{title:"Study name",data:"Study name"},{title:"Start date",data:"Start date",render:function(e){return formatDayMonthYear(getJsDateFromExcel(e))}},{title:"End date",data:"End date",render:function(e){return formatDayMonthYear(getJsDateFromExcel(e))}},{title:"Mental health measures used",data:"Measures",class:"none"},{title:"Participants",data:"Participants",class:"none"},{title:"Data collection method",data:"Methodology",class:"none"},{title:"Data access",data:"Data access",class:"none"},{title:"Comments",data:"Comments",class:"none"},{title:"Links",data:"Links",class:"none"}],order:[1,"asc"]}),$("#dataTable").dataTable().fnAdjustColumnSizing(),$("#dataTable").dataTable().css("width","100%"),$("#dataTable").DataTable().on("responsive-display",function(e,t,a,l,i){l&&(a.nodes().to$().next().find("td.child").each(function(){$(this).attr("colspan",$(this).attr("colspan")-1),$(this).before("<td></td>")}),$("li[data-dt-row='"+a.index()+"'] .dtr-data").each(function(){""==$(this).text()&&$(this).parent().hide()}))}),$("#dataTable_filter").insertAfter($("#line")),$("#dataTable_filter  input").addClass("form-control").attr("placeholder","Search sweeps for ...").appendTo($("#dataTable_filter")),$("#dataTable_filter > label").remove(),l=n?0:1;l<dates.length-1;l++){var d=(dates[l]-i)/s;$("#line").append('<div class="circle" id="circle'+l+'" style="left: '+100*d+'%;"><div class="popupSpan label">'+e[dates[l]]+'</div><div class="popupSpan tree"><i class="fa fa-tree"></i></div></div>')}for(l=n?1:0;l<t.length;l++){d=(t[l]-i)/s;let e="above";[1,3,4].includes(l)&&(e="below"),[3,2].includes(l)&&(e+=" hideable"),$("#line").append('<div class="labelLine '+e+'" id="labelLine'+l+'" style="left: '+100*d+'%;"><div class="popupSpan label">'+a[l]+"</div></div>")}$("#line").append('<div class="circle labelled right" id="circle'+(dates.length-1)+'" style="right:0;"><div class="popupSpan label">'+e[dates[dates.length-1]]+'</div><div class="popupSpan tree"><i class="fa fa-tree"></i></div></div>');$("#dataTable").DataTable().on("search.dt",function(){$(".tree").removeClass("treeShown");var e=$("#dataTable").DataTable().search();if(!(e.length<3)){var t=e.match(/(?:[^\s"]+|"[^"]*")+/g);for(var a in t)t[a].length<3&&t.splice(a,1);l="^(?=[\\s\\S]*("+(l=t.join("))(?=[\\s\\S]*(")+"))").replace(/["]/g,"");var l=new RegExp(l,"i"),i=[];for($.each(fullSweeps,function(e,t){var a="";for(var s in t)a+=t[s]+" ";if(l.test(a)){let e=getJsDateFromExcel(t["Start date"]).getTime();e>Date.parse("2020-09-15")&&e<Date.parse("2021-02-01")&&(e=Date.parse("2020-11-15")),e>Date.parse("2021-03-01")&&e<Date.parse("2021-06-02")&&(e=Date.parse("2021-04-15")),e=String(e),-1==i.indexOf(dates.indexOf(e))&&i.push(dates.indexOf(e))}}),a=0;a<i.length;a++)$("#circle"+i[a]+" .tree").addClass("treeShown")}}),dates.length<2&&($("#timeline .sweepTitle").html("Showing measures used in sweep: <b>"+e[dates[0]]+"</b><br><i>No other sweeps</i>").addClass("mb-4"),$("#line").hide()),selectDate($(".circle:first").attr("id")),$(".circle").mouseenter(function(){$(this).addClass("hover")}),$(".circle").mouseleave(function(){$(this).removeClass("hover")}),$(".circle").click(function(){var t=$(this).attr("id"),a=t.replace("circle","");selectDate(t),gtag("event","click",{event_label:"Study: "+$("#studyid").val()+" Sweep: "+e[dates[a]],event_category:"Timeline",transport_type:"beacon"})})}function selectDate(e){$(".active").removeClass("active"),$("#"+e).addClass("active");var t=e.replace("circle",""),a=dates[t];$("#timeline .sweepTitle").html("Showing studies collecting data in: <b>"+sweeps[dates[t]]+"</b><br><i>click on the timeline to see other timepoints");var l=fullSweeps.filter(function(e){return"Autumn/Winter 2020"==sweeps[dates[t]]||"Spring 2021"==sweeps[dates[t]]?Math.abs(getJsDateFromExcel(e["Start date"])-dates[t])<5184e6:getJsDateFromExcel(e["Start date"]).getTime()==Number(a)});$("#dataTable").dataTable().fnClearTable(),$("#dataTable").dataTable().fnAddData(l),$("#dataTable").dataTable().fnAdjustColumnSizing(),$("#dataTable").dataTable().css("width","100%"),t>0&&collide($("#"+e+" .label")[0],$("#circle0 .label")[0])?$("#circle0 .label").css("visibility","hidden"):$("#circle0 .label").css("visibility","visible"),t<dates.length-1&&collide($("#"+e+" .label")[0],$("#circle"+(dates.length-1)+" .label")[0])?$("#circle"+(dates.length-1)+" .label").css("visibility","hidden"):$("#circle"+(dates.length-1)+" .label").css("visibility","visible"),$('[data-toggle="tooltip"]').tooltip({container:"body",boundary:"window",offset:0})}function collide(e,t){var a=e.getBoundingClientRect(),l=t.getBoundingClientRect();return!(a.top>l.bottom||a.right<l.left||a.bottom<l.top||a.left>l.right)}